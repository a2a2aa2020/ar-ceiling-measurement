<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ŸÇŸäÿßÿ≥ ŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑÿ≥ŸÇŸÅ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: Arial, sans-serif;
            background: #0a0a0a;
            overflow: hidden;
            touch-action: none;
        }

        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        .info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .area {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        button {
            padding: 18px 40px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-main {
            background: white;
            color: #667eea;
        }

        .btn-clear {
            background: #ff6b6b;
            color: white;
        }
    </style>
</head>

<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="info" id="info">ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£" ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿ∑ŸäŸÑ</div>
    <div class="area" id="area">0 ŸÖ¬≤</div>

    <div class="controls">
        <button class="btn-main" id="btnStart">ÿßÿ®ÿØÿ£</button>
        <button class="btn-clear" id="btnClear">ŸÖÿ≥ÿ≠</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const areaDisplay = document.getElementById('area');
        const btnStart = document.getElementById('btnStart');
        const btnClear = document.getElementById('btnClear');

        // Setup canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // State
        let rectangle = null;
        let dragging = null;
        let cameraActive = false;

        // Rectangle structure
        function createRectangle() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const w = 300; // pixels
            const h = 400;

            return {
                x: centerX - w / 2,
                y: centerY - h / 2,
                width: w,
                height: h,
                corners: [
                    { x: centerX - w / 2, y: centerY - h / 2, name: 'ÿ£ÿπŸÑŸâ Ÿäÿ≥ÿßÿ±' },
                    { x: centerX + w / 2, y: centerY - h / 2, name: 'ÿ£ÿπŸÑŸâ ŸäŸÖŸäŸÜ' },
                    { x: centerX - w / 2, y: centerY + h / 2, name: 'ÿ£ÿ≥ŸÅŸÑ Ÿäÿ≥ÿßÿ±' },
                    { x: centerX + w / 2, y: centerY + h / 2, name: 'ÿ£ÿ≥ŸÅŸÑ ŸäŸÖŸäŸÜ' }
                ]
            };
        }

        // Calculate area (assuming 100 pixels = 1 meter for demo)
        function calculateArea() {
            if (!rectangle) return 0;
            const widthMeters = rectangle.width / 100;
            const heightMeters = rectangle.height / 100;
            return (widthMeters * heightMeters).toFixed(2);
        }

        // Draw rectangle
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!rectangle) return;

            // Draw rectangle
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);

            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 4;
            ctx.strokeRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            const gridSize = 50;

            for (let i = gridSize; i < rectangle.width; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(rectangle.x + i, rectangle.y);
                ctx.lineTo(rectangle.x + i, rectangle.y + rectangle.height);
                ctx.stroke();
            }

            for (let i = gridSize; i < rectangle.height; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(rectangle.x, rectangle.y + i);
                ctx.lineTo(rectangle.x + rectangle.width, rectangle.y + i);
                ctx.stroke();
            }

            // Draw corners (bigger for easier touch)
            rectangle.corners.forEach((corner, i) => {
                // White circle
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(corner.x, corner.y, 25, 0, Math.PI * 2);
                ctx.fill();

                // Blue inner
                ctx.fillStyle = dragging === i ? '#ff6b6b' : '#667eea';
                ctx.beginPath();
                ctx.arc(corner.x, corner.y, 20, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw dimensions
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';

            // Width (top)
            const widthText = `${(rectangle.width / 100).toFixed(2)} ŸÖ`;
            ctx.fillText(widthText, rectangle.x + rectangle.width / 2, rectangle.y - 15);

            // Height (left)
            const heightText = `${(rectangle.height / 100).toFixed(2)} ŸÖ`;
            ctx.save();
            ctx.translate(rectangle.x - 20, rectangle.y + rectangle.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(heightText, 0, 0);
            ctx.restore();
        }

        // Touch/Mouse handlers
        function getTouch(e) {
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: touch.clientX,
                y: touch.clientY
            };
        }

        function findCorner(x, y) {
            if (!rectangle) return -1;

            for (let i = 0; i < rectangle.corners.length; i++) {
                const corner = rectangle.corners[i];
                const dx = x - corner.x;
                const dy = y - corner.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 40) { // Touch radius
                    return i;
                }
            }
            return -1;
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', start);

        function start(e) {
            e.preventDefault();
            const pos = getTouch(e);
            const cornerIndex = findCorner(pos.x, pos.y);

            if (cornerIndex >= 0) {
                dragging = cornerIndex;
                info.textContent = `ÿßÿ≥ÿ≠ÿ® ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≠ÿ¨ŸÖ`;
            }
        }

        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', move);

        function move(e) {
            if (dragging === null || !rectangle) return;
            e.preventDefault();

            const pos = getTouch(e);
            const corner = rectangle.corners[dragging];
            corner.x = pos.x;
            corner.y = pos.y;

            // Update rectangle bounds
            const xs = rectangle.corners.map(c => c.x);
            const ys = rectangle.corners.map(c => c.y);
            rectangle.x = Math.min(...xs);
            rectangle.y = Math.min(...ys);
            rectangle.width = Math.max(...xs) - rectangle.x;
            rectangle.height = Math.max(...ys) - rectangle.y;

            // Update area display
            areaDisplay.textContent = calculateArea() + ' ŸÖ¬≤';

            draw();
        }

        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('touchend', end);

        function end(e) {
            if (dragging !== null) {
                dragging = null;
                info.textContent = `ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ©: ${calculateArea()} ŸÖ¬≤`;
            }
        }

        // Start button
        btnStart.addEventListener('click', async () => {
            // Try camera (asks for permission)
            if (!cameraActive) {
                try {
                    info.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß...';

                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });

                    video.srcObject = stream;
                    cameraActive = true;
                    info.textContent = '‚úì ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÜÿ¥ÿ∑ÿ© - Ÿàÿ¨ŸëŸá ŸÑŸÑÿ≥ŸÇŸÅ';

                } catch (err) {
                    cameraActive = false;
                    video.style.display = 'none';
                    canvas.style.background = 'linear-gradient(135deg, #1a1a2e, #0f0f1e)';

                    // Show specific error
                    if (err.name === 'NotAllowedError') {
                        info.textContent = '‚ö†Ô∏è ÿ±ŸÅÿ∂ÿ™ ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÉÿßŸÖŸäÿ±ÿß';
                    } else if (err.name === 'NotFoundError') {
                        info.textContent = '‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÉÿßŸÖŸäÿ±ÿß';
                    } else if (err.name === 'NotSupportedError') {
                        info.textContent = '‚ö†Ô∏è Ÿäÿ≠ÿ™ÿßÿ¨ HTTPS';
                    } else {
                        info.textContent = '‚ö†Ô∏è ÿÆÿ∑ÿ£: ' + err.message;
                    }

                    console.error('Camera error:', err.name, err.message);
                }
            }

            // Create rectangle (always works)
            if (!rectangle) {
                rectangle = createRectangle();
                areaDisplay.textContent = calculateArea() + ' ŸÖ¬≤';
                draw();

                setTimeout(() => {
                    if (cameraActive) {
                        info.textContent = 'üëÜ ÿßÿ≥ÿ≠ÿ® ÿßŸÑÿ≤ŸàÿßŸäÿß - ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÜÿ¥ÿ∑ÿ©';
                    } else {
                        info.textContent = 'üëÜ ÿßÿ≥ÿ≠ÿ® ÿßŸÑÿ≤ŸàÿßŸäÿß';
                    }
                }, 2000);
            }
        });

        // Clear button
        btnClear.addEventListener('click', () => {
            rectangle = null;
            dragging = null;
            areaDisplay.textContent = '0 ŸÖ¬≤';
            info.textContent = 'ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠ - ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£"';
            draw();
        });

        // Resize handler
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        });

        // Initial draw
        draw();
        console.log('‚úì ÿ¨ÿßŸáÿ≤');
    </script>
</body>

</html>
