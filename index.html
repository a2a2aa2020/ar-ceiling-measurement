<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>قياس مع الارتفاع</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        #video, #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #video { object-fit: cover; z-index: 1; opacity: 0.7; }
        #canvas { z-index: 2; }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .header {
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            color: white; padding: 20px; text-align: center; pointer-events: auto;
        }

        .result-box {
            font-size: 32px; font-weight: bold; color: #4facfe; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .footer {
            background: rgba(20, 20, 30, 0.9); padding: 20px;
            border-radius: 25px 25px 0 0; pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        /* تنسيق حقل الإدخال */
        .input-group {
            background: rgba(255,255,255,0.1);
            padding: 10px; border-radius: 12px;
            margin-bottom: 15px; text-align: right;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .input-label {
            color: #aaa; font-size: 12px; margin-bottom: 5px; display: block;
        }

        .height-input-wrapper {
            display: flex; align-items: center; gap: 10px;
        }

        input[type="number"] {
            background: transparent; border: none; color: white;
            font-size: 20px; font-weight: bold; width: 80px;
            border-bottom: 2px solid #4facfe; text-align: center;
        }
        
        input[type="number"]:focus { outline: none; border-bottom-color: #fff; }

        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: 0.2s;
        }
        button:active { transform: scale(0.96); }
        .btn-cam { background: #4facfe; color: white; }
        .btn-reset { background: #ff5858; color: white; }

        /* أيقونات بسيطة للتوضيح */
        .icon-ruler { display: inline-block; width: 20px; height: 20px; background: #4facfe; border-radius: 50%; margin-left: 8px; vertical-align: middle; }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="ui-layer">
        <div class="header">
            <div class="result-box" id="areaDisplay">0.00 م²</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top:5px;">المساحة المقدرة</div>
        </div>

        <div class="footer">
            <div class="input-group">
                <label class="input-label">أدخل المسافة بين الكاميرا والسقف لضبط القياس:</label>
                <div class="height-input-wrapper">
                    <span style="font-size:20px;">↕️</span>
                    <input type="number" id="heightInput" value="2.5" step="0.1" inputmode="decimal">
                    <span style="color:white; font-weight:bold;">متر</span>
                </div>
                <div style="font-size: 10px; color: #888; margin-top: 5px;">* الرقم الافتراضي 2.5 متر (ارتفاع سقف قياسي)</div>
            </div>

            <div class="btn-group">
                <button class="btn-cam" id="btnCam">تشغيل الكاميرا</button>
                <button class="btn-reset" id="btnReset">إعادة رسم</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        const heightInput = document.getElementById('heightInput');
        
        let points = [];
        let draggingIdx = -1;
        
        // ثابت بكسل/متر (سيتم حسابه بناءً على الارتفاع)
        let pixelsPerMeter = 100; 

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            resetPoints();
            recalculateScale(); // حساب المقياس عند البدء
        }

        // --- المنطق الرياضي الجديد ---
        function recalculateScale() {
            // 1. نأخذ الارتفاع الذي أدخله المستخدم (h)
            const h = parseFloat(heightInput.value) || 2.5;

            // 2. نقدر مجال الرؤية الرأسي (Vertical FOV)
            // معظم كاميرات الجوال لديها زاوية رؤية رأسية تقارب 60 درجة تقريباً
            // المعادلة: الارتفاع المرئي في الكاميرا = 2 * بعد الكاميرا * tan(FOV/2)
            // tan(30 degrees) ≈ 0.577
            // إذن: الارتفاع المرئي (بالمتر) = h * 2 * 0.577 ≈ h * 1.15
            
            // هذا يعني: إذا كان السقف يبعد متر واحد، الكاميرا ترى مسافة رأسية قدرها 1.15 متر
            const visibleHeightMeters = h * 1.15;

            // 3. نحسب كم بكسل في المتر الواحد
            pixelsPerMeter = canvas.height / visibleHeightMeters;

            draw(); // تحديث الأرقام على الشاشة
        }

        function resetPoints() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const size = Math.min(canvas.width, canvas.height) * 0.25;
            
            points = [
                { x: cx - size, y: cy - size },
                { x: cx + size, y: cy - size },
                { x: cx + size, y: cy + size },
                { x: cx - size, y: cy + size }
            ];
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // رسم المضلع
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.closePath();
            
            ctx.fillStyle = 'rgba(79, 172, 254, 0.25)';
            ctx.fill();
            ctx.strokeStyle = '#4facfe';
            ctx.lineWidth = 3;
            ctx.stroke();

            // رسم النقاط
            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = (i === draggingIdx) ? '#ff5858' : 'white';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // رسم الأبعاد
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            
            points.forEach((p, i) => {
                const nextP = points[(i + 1) % points.length];
                const distPx = Math.hypot(nextP.x - p.x, nextP.y - p.y);
                
                // التحويل باستخدام المقياس المحسوب
                const distM = (distPx / pixelsPerMeter).toFixed(2);
                
                const midX = (p.x + nextP.x) / 2;
                const midY = (p.y + nextP.y) / 2;
                
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(midX - 22, midY - 12, 44, 24);
                ctx.fillStyle = 'white';
                ctx.fillText(distM + 'm', midX, midY + 5);
            });

            updateArea();
        }

        function updateArea() {
            let areaPx = 0;
            const n = points.length;
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                areaPx += points[i].x * points[j].y;
                areaPx -= points[j].x * points[i].y;
            }
            areaPx = Math.abs(areaPx) / 2;
            
            // تحويل المساحة
            const areaMeters = (areaPx / (pixelsPerMeter * pixelsPerMeter)).toFixed(2);
            document.getElementById('areaDisplay').innerText = areaMeters + ' م²';
        }

        // أحداث الإدخال
        heightInput.addEventListener('input', recalculateScale);
        heightInput.addEventListener('change', recalculateScale);

        // أحداث اللمس (نفس السابق)
        function getTouchPos(e) {
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX, y: t.clientY };
        }

        function onDown(e) {
            const pos = getTouchPos(e);
            let closestDist = 60; 
            let closestIdx = -1;

            points.forEach((p, i) => {
                const dist = Math.hypot(p.x - pos.x, p.y - pos.y);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestIdx = i;
                }
            });

            if (closestIdx !== -1) {
                draggingIdx = closestIdx;
                draw();
            }
        }

        function onMove(e) {
            if (draggingIdx === -1) return;
            e.preventDefault();
            const pos = getTouchPos(e);
            points[draggingIdx].x = pos.x;
            points[draggingIdx].y = pos.y;
            draw();
        }

        function onUp() { draggingIdx = -1; draw(); }

        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('touchstart', onDown, { passive: false });
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchend', onUp);

        document.getElementById('btnCam').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
            } catch (e) {
                alert("يرجى استخدام HTTPS وتشغيل الكاميرا");
            }
        };

        document.getElementById('btnReset').onclick = resetPoints;

        initCanvas();
        window.onresize = initCanvas;
    </script>
</body>
</html>
