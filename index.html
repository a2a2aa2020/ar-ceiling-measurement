<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>قياس مساحة السقف (مضلع حر)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: Arial, sans-serif; background: #0a0a0a; overflow: hidden; touch-action: none; }
        #video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; }
        #canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; touch-action: none; }
        
        .info {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 16px; text-align: center; z-index: 100;
            backdrop-filter: blur(5px); width: 90%; max-width: 400px;
        }

        .area {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2); color: white;
            padding: 15px 30px; border-radius: 15px; font-size: 28px; font-weight: bold;
            z-index: 100; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); white-space: nowrap;
        }

        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 100; width: 90%; max-width: 400px; justify-content: center;
        }

        button {
            flex: 1; padding: 15px; font-size: 18px; font-weight: bold; border: none;
            border-radius: 12px; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .btn-main { background: white; color: #667eea; }
        .btn-clear { background: #ff6b6b; color: white; }
    </style>
</head>

<body>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="info" id="info">اضغط "ابدأ" ثم اسحب الزوايا لتطابق السقف</div>
    <div class="area" id="area">0.00 م²</div>

    <div class="controls">
        <button class="btn-main" id="btnStart">ابدأ الكاميرا</button>
        <button class="btn-clear" id="btnClear">إعادة تعيين</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const areaDisplay = document.getElementById('area');
        const btnStart = document.getElementById('btnStart');
        const btnClear = document.getElementById('btnClear');

        // إعداد الكانفاس
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(polygon) draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // الحالة (State)
        let polygon = null; // المضلع بدلاً من المستطيل
        let draggingPoint = null; // النقطة التي يتم سحبها
        let cameraActive = false;
        
        // معامل التحويل (هام جداً: هذا الرقم افتراضي)
        // في الواقع نحتاج ARKit/ARCore لحساب العمق بدقة.
        // هنا نفترض أن كل 100 بكسل تعادل 1 متر تقريباً.
        const PIXELS_PER_METER = 100; 

        // إنشاء المضلع الافتراضي (مربع في المنتصف)
        function createPolygon() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const size = 150; 

            return [
                { x: cx - size, y: cy - size }, // أعلى يسار
                { x: cx + size, y: cy - size }, // أعلى يمين
                { x: cx + size, y: cy + size }, // أسفل يمين
                { x: cx - size, y: cy + size }  // أسفل يسار
            ];
        }

        // خوارزمية "رباط الحذاء" (Shoelace Formula) لحساب مساحة أي مضلع
        function calculatePolygonArea(points) {
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                // تحويل الإحداثيات من بكسل إلى متر قبل الضرب
                const x_i = points[i].x / PIXELS_PER_METER;
                const y_i = points[i].y / PIXELS_PER_METER;
                const x_j = points[j].x / PIXELS_PER_METER;
                const y_j = points[j].y / PIXELS_PER_METER;
                
                area += x_i * y_j;
                area -= x_j * y_i;
            }
            
            return (Math.abs(area) / 2).toFixed(2);
        }

        // دالة الرسم
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!polygon) return;

            // رسم الشكل المظلل
            ctx.beginPath();
            ctx.moveTo(polygon[0].x, polygon[0].y);
            for (let i = 1; i < polygon.length; i++) {
                ctx.lineTo(polygon[i].x, polygon[i].y);
            }
            ctx.closePath();
            
            ctx.fillStyle = 'rgba(102, 126, 234, 0.25)';
            ctx.fill();
            
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.stroke();

            // رسم خطوط الشبكة الوهمية داخل الشكل (اختياري - لجمالية الشكل)
            // (تم إزالتها لتبسيط الكود ودعم الأشكال غير المنتظمة)

            // رسم الزوايا (النقاط)
            polygon.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                // النقطة النشطة
                if (draggingPoint === i) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 15, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff6b6b';
                    ctx.fill();
                }
                
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // تحديث عرض المساحة
            const area = calculatePolygonArea(polygon);
            areaDisplay.textContent = `${area} م²`;
            
            // رسم الأبعاد (الأطوال) بين النقاط
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i < polygon.length; i++) {
                const p1 = polygon[i];
                const p2 = polygon[(i + 1) % polygon.length];
                
                const midX = (p1.x + p2.x) / 2;
                const midY = (p1.y + p2.y) / 2;
                
                // المسافة (فيثاغورس)
                const distPixels = Math.hypot(p2.x - p1.x, p2.y - p1.y);
                const distMeters = (distPixels / PIXELS_PER_METER).toFixed(2);
                
                ctx.fillText(`${distMeters} م`, midX, midY);
            }
        }

        // التعامل مع اللمس والماوس
        function getPos(e) {
            const touch = e.touches ? e.touches[0] : e;
            return { x: touch.clientX, y: touch.clientY };
        }

        function isNearPoint(x, y, p) {
            return Math.hypot(x - p.x, y - p.y) < 40; // نصف قطر اللمس
        }

        function handleStart(e) {
            e.preventDefault(); // منع التمرير
            if (!polygon) return;
            
            const pos = getPos(e);
            
            // البحث عن أقرب نقطة تم الضغط عليها
            for (let i = 0; i < polygon.length; i++) {
                if (isNearPoint(pos.x, pos.y, polygon[i])) {
                    draggingPoint = i;
                    info.textContent = 'حرّك الزاوية لمطابقة السقف';
                    draw();
                    return;
                }
            }
        }

        function handleMove(e) {
            e.preventDefault();
            if (draggingPoint === null || !polygon) return;

            const pos = getPos(e);
            
            // تحديث مكان النقطة فقط (حركة حرة)
            polygon[draggingPoint].x = pos.x;
            polygon[draggingPoint].y = pos.y;
            
            draw();
        }

        function handleEnd(e) {
            if (draggingPoint !== null) {
                draggingPoint = null;
                const area = calculatePolygonArea(polygon);
                info.textContent = `المساحة الحالية: ${area} م²`;
                draw();
            }
        }

        // مستمعات الأحداث
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchend', handleEnd);

        // تشغيل الكاميرا
        btnStart.addEventListener('click', async () => {
            if (!polygon) {
                polygon = createPolygon();
                draw();
            }

            if (!cameraActive) {
                try {
                    info.textContent = 'جاري تشغيل الكاميرا...';
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    video.srcObject = stream;
                    cameraActive = true;
                    info.textContent = 'اضبط الزوايا الأربعة على حدود السقف';
                } catch (err) {
                    console.error(err);
                    info.textContent = 'تعذر الوصول للكاميرا (تأكد من HTTPS)';
                    // نستمر حتى بدون كاميرا كوضع "رسم"
                }
            }
        });

        // زر إعادة التعيين
        btnClear.addEventListener('click', () => {
            polygon = createPolygon(); // إعادة الشكل للوضع الافتراضي
            info.textContent = 'تمت إعادة التعيين';
            draw();
        });

        // الرسم الأولي
        info.textContent = 'اضغط "ابدأ الكاميرا" للبدء';
    </script>
</body>
</html>
