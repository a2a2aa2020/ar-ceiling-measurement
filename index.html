<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù‚ÙŠØ§Ø³ Ø°ÙƒÙŠ (Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø¶Ù„Ø¹)</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        #video, #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #video { object-fit: cover; opacity: 0.7; }
        #canvas { z-index: 2; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .header {
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
            color: white; padding: 20px; text-align: center; pointer-events: auto;
        }

        .area-display {
            font-size: 42px; font-weight: bold; color: #4facfe; text-shadow: 0 2px 4px black;
        }

        .instruction {
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px;
            font-size: 13px; color: #eee; margin-top: 5px; display: inline-block;
        }

        .footer {
            background: rgba(20, 20, 30, 0.9); padding: 20px; text-align: center;
            border-radius: 20px 20px 0 0; pointer-events: auto;
        }

        button.btn-cam {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
        }

        /* Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø·ÙˆÙ„ (Modal) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
            justify-content: center; align-items: center; pointer-events: auto;
        }

        .modal-box {
            background: #1e1e24; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px;
            text-align: center; color: white; border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-input {
            width: 100px; background: #333; border: 2px solid #4facfe; border-radius: 8px;
            padding: 10px; color: white; font-size: 24px; text-align: center; margin: 15px 0;
            outline: none;
        }

        .modal-btn {
            background: #4facfe; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;
        }
        
        .modal-close {
            background: transparent; color: #aaa; border: none; margin-top: 10px; cursor: pointer;
        }

    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <div class="ui-layer">
        <div class="header">
            <div class="area-display" id="areaText">0.00 Ù…Â²</div>
            <div class="instruction">
                ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ù„Ø¹ Ù„ØªØºÙŠÙŠØ± Ø·ÙˆÙ„Ù‡
            </div>
        </div>

        <div class="footer">
            <button class="btn-cam" id="btnCam">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        </div>
    </div>

    <div class="modal-overlay" id="calibrationModal">
        <div class="modal-box">
            <h3 style="margin:0;">Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
            <p style="color:#aaa; font-size:14px; margin:10px 0;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶Ù„Ø¹ Ø¨Ø§Ù„Ù…ØªØ±:</p>
            
            <input type="number" id="realLengthInput" class="modal-input" placeholder="0.00" inputmode="decimal">
            <span style="font-size:18px; font-weight:bold;">Ù…ØªØ±</span>
            
            <br>
            <button class="modal-btn" onclick="applyCalibration()">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="modal-close" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        const modal = document.getElementById('calibrationModal');
        const realLengthInput = document.getElementById('realLengthInput');
        const areaText = document.getElementById('areaText');

        let points = [];
        let pixelsPerMeter = 100; // Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©
        let draggingIdx = -1;
        let selectedSideIdx = -1; // Ø§Ù„Ø¶Ù„Ø¹ Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ù…Ø¹Ø§ÙŠØ±ØªÙ‡
        
        // Ø£Ù…Ø§ÙƒÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ØµÙˆØµ (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§)
        let textHitboxes = [];

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ·ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            points = [
                { x: cx - 100, y: cy - 100 },
                { x: cx + 100, y: cy - 100 },
                { x: cx + 100, y: cy + 100 },
                { x: cx - 100, y: cy + 100 }
            ];
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Ø±Ø³Ù… Ø§Ù„Ù…Ø¶Ù„Ø¹
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.closePath();
            
            ctx.fillStyle = 'rgba(79, 172, 254, 0.25)';
            ctx.fill();
            ctx.strokeStyle = '#4facfe';
            ctx.lineWidth = 3;
            ctx.stroke();

            // 2. Ø±Ø³Ù… Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø²ÙˆØ§ÙŠØ§)
            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = (i === draggingIdx) ? '#ff5858' : 'white';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // 3. Ø±Ø³Ù… Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ØµÙˆØµ
            textHitboxes = []; // ØªØµÙÙŠØ± Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù†ØµÙˆØµ
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            points.forEach((p, i) => {
                const nextP = points[(i + 1) % points.length];
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
                const distPx = Math.hypot(nextP.x - p.x, nextP.y - p.y);
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ù…ØªØ±
                const distM = (distPx / pixelsPerMeter).toFixed(2);
                
                const midX = (p.x + nextP.x) / 2;
                const midY = (p.y + nextP.y) / 2;
                
                // Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Øµ (Ø²Ø± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·)
                const text = distM + 'm';
                const w = 60;
                const h = 30;
                
                ctx.fillStyle = '#1e1e24'; // Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ù„Ù„Ø®Ù„ÙÙŠØ©
                ctx.beginPath();
                ctx.roundRect(midX - w/2, midY - h/2, w, h, 8);
                ctx.fill();
                
                // Ø¥Ø·Ø§Ø± Ù„Ù„Ø²Ø±
                ctx.strokeStyle = '#4facfe';
                ctx.lineWidth = 1;
                ctx.stroke();

                ctx.fillStyle = '#4facfe'; // Ù„ÙˆÙ† Ø§Ù„Ù†Øµ
                ctx.fillText(text, midX, midY);

                // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¶ØºØ· Ù„Ø§Ø­Ù‚Ø§Ù‹
                textHitboxes.push({
                    idx: i,
                    x: midX,
                    y: midY,
                    w: w,
                    h: h,
                    distPx: distPx // Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø·ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ Ù„Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
                });
            });

            updateArea();
        }

        function updateArea() {
            let area = 0;
            const n = points.length;
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            area = Math.abs(area) / 2;
            const areaMeters = (area / (pixelsPerMeter * pixelsPerMeter)).toFixed(2);
            areaText.innerText = areaMeters + ' Ù…Â²';
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ---

        function openCalibration(idx) {
            selectedSideIdx = idx;
            // Ø¹Ø±Ø¶ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
            const currentMeters = (textHitboxes[idx].distPx / pixelsPerMeter).toFixed(2);
            realLengthInput.value = currentMeters;
            modal.style.display = 'flex';
            realLengthInput.focus();
            realLengthInput.select();
        }

        function applyCalibration() {
            const newMeters = parseFloat(realLengthInput.value);
            if (newMeters > 0 && selectedSideIdx !== -1) {
                // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© / Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ = Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const pixelsOfSide = textHitboxes[selectedSideIdx].distPx;
                pixelsPerMeter = pixelsOfSide / newMeters;
                
                closeModal();
                draw(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            } else {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 0");
            }
        }

        function closeModal() {
            modal.style.display = 'none';
            selectedSideIdx = -1;
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„Ø¶ØºØ· ---
        
        function getPos(e) {
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX, y: t.clientY };
        }

        function onDown(e) {
            const pos = getPos(e);
            
            // 1. Ù‡Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†ØµÙˆØµ (Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©)ØŸ
            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹ÙƒØ³ÙŠ Ù„Ø£Ù† Ø§Ù„Ù†ØµÙˆØµ ØªÙØ±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„Ø®Ø·ÙˆØ·
            for (let i = 0; i < textHitboxes.length; i++) {
                const box = textHitboxes[i];
                // ÙØ­Øµ Ø§Ù„ØªØµØ§Ø¯Ù… Ø§Ù„Ø¨Ø³ÙŠØ· (Ù…Ø³ØªØ·ÙŠÙ„)
                if (pos.x >= box.x - box.w/2 && pos.x <= box.x + box.w/2 &&
                    pos.y >= box.y - box.h/2 && pos.y <= box.y + box.h/2) {
                    openCalibration(box.idx);
                    return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø§Ù„Ø³Ø­Ø¨
                }
            }

            // 2. Ù‡Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø§ÙˆÙŠØ© (Ø§Ù„Ø³Ø­Ø¨)ØŸ
            let closestDist = 50;
            let closestIdx = -1;
            points.forEach((p, i) => {
                const dist = Math.hypot(p.x - pos.x, p.y - pos.y);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestIdx = i;
                }
            });

            if (closestIdx !== -1) {
                draggingIdx = closestIdx;
                draw();
            }
        }

        function onMove(e) {
            if (draggingIdx === -1) return;
            e.preventDefault();
            const pos = getPos(e);
            points[draggingIdx].x = pos.x;
            points[draggingIdx].y = pos.y;
            draw();
        }

        function onUp() { draggingIdx = -1; draw(); }

        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('touchstart', onDown, { passive: false });
        canvas.addEventListener('mousemove', onMove);
        canvas.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchend', onUp);

        // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        document.getElementById('btnCam').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
            } catch(e) { alert("ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        };

        window.onresize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        };

        initCanvas();
    </script>
</body>
</html>
